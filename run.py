import os
from app import create_app
from app.core.config import DevelopmentConfig
from app.services.initial_load_service import refresh_estate_data_from_mysql
from app.core.extensions import db
from app.models.user_models import User, Role

app = create_app(DevelopmentConfig)

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É-—Ñ–ª–∞–≥—É
LOCK_FILE_PATH = os.path.join(app.instance_path, 'update.lock')


def create_initial_admin():
    """–°–æ–∑–¥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 'admin', –µ—Å–ª–∏ –æ–Ω –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç."""
    with app.app_context():
        from app.models import discount_models, estate_models, exclusion_models
        db.create_all()
        if User.query.filter_by(username='admin').first() is None:
            print("[SETUP] üë§ –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 'admin'...")
            admin_user = User(username='admin', role=Role.ADMIN)
            admin_user.set_password('admin')
            db.session.add(admin_user)
            db.session.commit()
            print("[SETUP] ‚úîÔ∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 'admin' —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω.")
        else:
            print("[SETUP] ‚ÑπÔ∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 'admin' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.")


# –≠—Ç–æ—Ç –±–ª–æ–∫ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–∞
if os.environ.get('WERKZEUG_RUN_MAIN') is None:
    # –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ try...finally
    try:
        # 1. –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª-—Ñ–ª–∞–≥ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        with open(LOCK_FILE_PATH, 'w') as f:
            f.write('locked')
        print(f"[UPDATE FLAG] –§–∞–π–ª –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å–æ–∑–¥–∞–Ω: {LOCK_FILE_PATH}")

        # –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        with app.app_context():
            refresh_estate_data_from_mysql()
    finally:
        # 3. –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —É–¥–∞–ª—è–µ–º —Ñ–∞–π–ª-—Ñ–ª–∞–≥ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–ª–∏ –æ—à–∏–±–∫–∏
        if os.path.exists(LOCK_FILE_PATH):
            os.remove(LOCK_FILE_PATH)
            print(f"[UPDATE FLAG] –§–∞–π–ª –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —É–¥–∞–ª–µ–Ω.")

    create_initial_admin()

if __name__ == '__main__':
    print("[FLASK APP] üö¶ –ó–∞–ø—É—Å–∫ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ Flask...")
    app.run(host='0.0.0.0', port=5000, debug=True)