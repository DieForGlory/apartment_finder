{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>–î–µ–π—Å—Ç–≤—É—é—â–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å–∫–∏–¥–æ–∫</h1>
</div>

<div class="form-group mb-4">
    <input type="text" id="searchInput" class="form-control form-control-lg" placeholder="üîç –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ñ–ö –¥–ª—è –ø–æ–∏—Å–∫–∞...">
</div>

{% if structured_discounts %}
    <div class="accordion" id="discountsAccordion">
        {% for complex_name, data in structured_discounts.items() %}
            {% if data.summary.sum_100_payment > 0 or data.summary.sum_mortgage > 0 %}
            <div class="accordion-item mb-2" data-complex-name="{{ complex_name|lower }}">
                <h2 class="accordion-header" id="heading-{{ loop.index }}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ loop.index }}" aria-expanded="false" aria-controls="collapse-{{ loop.index }}">
                        <div class="w-100">
                            <div class="row align-items-center">
                                <div class="col-lg-4">
                                    <strong class="fs-5">{{ complex_name }}</strong>
                                </div>
                                <div class="col-lg-8">
                                    <div class="row align-items-center text-center">
                                        <div class="col-4">
                                            {% if data.summary.avg_remainder_price_sqm > 0 %}
                                                <div class="fw-bold fs-5" style="color: var(--gh-gold);">${{ "{:,.0f}".format(data.summary.avg_remainder_price_sqm) }}</div>
                                                <small class="text-muted" style="font-size: 0.7rem;">—Å—Ä. —Ü–µ–Ω–∞ –¥–Ω–∞ –∑–∞ –º¬≤</small>
                                            {% else %}
                                                <div class="fw-bold fs-6 text-warning" style="height: 35px; display: flex; align-items-center; justify-content: center;">–ö–≤–∞—Ä—Ç–∏—Ä—ã<br>—Ä–∞—Å–ø—Ä–æ–¥–∞–Ω—ã</div>
                                            {% endif %}
                                        </div>
                                        <div class="col-3">
                                        {% if data.summary.months_to_cadastre is not none %}
                                            <div class="fw-bold fs-5" style="color: var(--gh-gold);">{{ data.summary.months_to_cadastre }}</div>
                                            <small class="text-muted" style="font-size: 0.7rem;">–º–µ—Å. –¥–æ –∫–∞–¥–∞—Å—Ç—Ä–∞</small>
                                        {% endif %}
                                        </div>
                                        <div class="col-5">
                                             <small class="text-muted" style="font-size: 0.8rem;">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å–∫–∏–¥–∫–∏</small>
                                            <div class="d-flex justify-content-center mt-1">
                                                <div class="px-2">
                                                    <div class="fw-bold fs-5" style="color: var(--gh-gold);">{{ "%.1f"|format(data.summary.sum_100_payment * 100) }}%</div>
                                                    <small class="text-muted" style="font-size: 0.7rem;">100% –û–ø–ª–∞—Ç–∞</small>
                                                </div>
                                                <div class="px-2">
                                                    <div class="fw-bold fs-5" style="color: var(--gh-gold);">{{ "%.1f"|format(data.summary.sum_mortgage * 100) }}%</div>
                                                    <small class="text-muted" style="font-size: 0.7rem;">–ò–ø–æ—Ç–µ–∫–∞</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-2 border-top pt-2">
                                {# –°–Ω–∞—á–∞–ª–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤—Å–µ —Ç–µ–≥–∏ #}
                                {% if data.summary.max_action_discount > 0 %}
                                    <span class="badge rounded-pill bg-danger-subtle border border-danger-subtle text-danger-emphasis fs-6 me-1">
                                        <i class="bi bi-star-fill"></i>
                                        –ê–∫—Ü–∏—è: {{ "%.1f"|format(data.summary.max_action_discount * 100) }}%
                                    </span>
                                {% endif %}
                                {% for tag in data.summary.available_tags|sort %}
                                    {% set tag_class = 'secondary' %}
                                    {% if tag == '–ö–î' %}{% set tag_class = 'success' %}{% endif %}
                                    {% if tag == '–û–ü–¢' %}{% set tag_class = 'info' %}{% endif %}
                                    {% if tag == '–•–æ–ª–¥–∏–Ω–≥' %}{% set tag_class = 'primary' %}{% endif %}
                                    <span class="badge rounded-pill bg-{{tag_class}}-subtle border border-{{tag_class}}-subtle text-{{tag_class}}-emphasis me-1">{{ tag }}</span>
                                {% endfor %}

                                {# –í –∫–æ–Ω—Ü–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å #}
                                {% if data.summary.complex_comment %}
                                <span class="ms-3 fst-italic text-muted" style="font-size: 0.85rem;">
                                    <i class="bi bi-chat-left-text"></i> {{ data.summary.complex_comment }}
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </button>
                </h2>
                <div id="collapse-{{ loop.index }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ loop.index }}">
                    <div class="accordion-body">
                        {% for prop_type, discounts in data.details.items() if discounts %}
                            <h5 class="mt-3">–¢–∏–ø –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏: <span class="badge bg-info-subtle border border-info-subtle text-info-emphasis rounded-pill">{{ prop_type }}</span></h5>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered mt-2">
                                    <thead class="table-light">
                                        <tr>
                                            <th>–¢–∏–ø –æ–ø–ª–∞—Ç—ã</th>
                                            <th>–î–∞—Ç–∞ –∫–∞–¥–∞—Å—Ç—Ä–∞</th>
                                            <th>–ú–ü–ü</th>
                                            <th>–†–û–ü</th>
                                            <th>–ö–î</th>
                                            <th>–û–ü–¢</th>
                                            <th>–ì–î</th>
                                            <th>–•–æ–ª–¥–∏–Ω–≥</th>
                                            <th>–ê–∫—Ü–∏–æ–Ω–µ—Ä</th>
                                            <th>–ê–∫—Ü–∏—è</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for discount in discounts|sort(attribute='payment_method.value') %}
                                            {% set payment_method_value = discount.payment_method.value %}
                                            {% set show_row = false %}
                                            {% if prop_type == 'flat' %}{% set show_row = true %}{% endif %}
                                            {% if prop_type in ['comm', 'storageroom'] and payment_method_value == '100% –æ–ø–ª–∞—Ç–∞' %}{% set show_row = true %}{% endif %}
                                            {% if prop_type == 'garage' and payment_method_value in ['100% –æ–ø–ª–∞—Ç–∞', '–ò–ø–æ—Ç–µ–∫–∞'] %}{% set show_row = true %}{% endif %}

                                            {% if show_row %}
                                            <tr>
                                                <td><strong>{{ payment_method_value }}</strong></td>
                                                <td>{{ discount.cadastre_date.strftime('%d.%m.%Y') if discount.cadastre_date else '‚Äî' }}</td>
                                                <td>{% if discount.mpp > 0 %}{{ "%.1f"|format(discount.mpp * 100) }}%{% else %}‚Äî{% endif %}</td>
                                                <td>{% if discount.rop > 0 %}{{ "%.1f"|format(discount.rop * 100) }}%{% else %}‚Äî{% endif %}</td>
                                                <td>{% if discount.kd > 0 %}{{ "%.1f"|format(discount.kd * 100) }}%{% else %}‚Äî{% endif %}</td>
                                                <td>{% if discount.opt > 0 %}{{ "%.1f"|format(discount.opt * 100) }}%{% else %}‚Äî{% endif %}</td>
                                                <td>{% if discount.gd > 0 %}{{ "%.1f"|format(discount.gd * 100) }}%{% else %}‚Äî{% endif %}</td>
                                                <td>{% if discount.holding > 0 %}{{ "%.1f"|format(discount.holding * 100) }}%{% else %}‚Äî{% endif %}</td>
                                                <td>{% if discount.shareholder > 0 %}{{ "%.1f"|format(discount.shareholder * 100) }}%{% else %}‚Äî{% endif %}</td>
                                                <td>{% if discount.action > 0 %}{{ "%.1f"|format(discount.action * 100) }}%{% else %}‚Äî{% endif %}</td>
                                            </tr>
                                            {% endif %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        {% endfor %}
    </div>
{% else %}
    <div class="alert alert-warning">–í —Å–∏—Å—Ç–µ–º–µ –ø–æ–∫–∞ –Ω–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö —Å–∫–∏–¥–æ–∫.</div>
{% endif %}
{% endblock %}


{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        const accordionItems = document.querySelectorAll('.accordion-item');
        searchInput.addEventListener('input', function (e) {
            const searchTerm = e.target.value.toLowerCase();
            accordionItems.forEach(function (item) {
                const complexName = item.dataset.complexName;
                if (complexName.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    }
});
</script>
{% endblock %}