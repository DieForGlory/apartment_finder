{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>–î–µ–π—Å—Ç–≤—É—é—â–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å–∫–∏–¥–æ–∫</h1>
</div>

<div class="row mb-4">
    <div class="col-md-8">
        <input type="text" id="searchInput" class="form-control form-control-lg" placeholder="üîç –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ñ–ö –¥–ª—è –ø–æ–∏—Å–∫–∞...">
    </div>
    <div class="col-md-4 d-flex align-items-center">
        <div class="form-check form-switch fs-5">
            <input class="form-check-input" type="checkbox" id="showOnlyCadastreSwitch">
            <label class="form-check-label text-muted" for="showOnlyCadastreSwitch" style="font-size: 0.9rem;">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å –¥–∞—Ç–æ–π –∫–∞–¥–∞—Å—Ç—Ä–∞</label>
        </div>
    </div>
</div>

{# –î–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å–∫–∏–¥–æ–∫ #}
<style>
    /* –°—Ç–∏–ª—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å–∫–∏–¥–æ–∫ */
    .accordion-item {
        background: rgba(0, 0, 0, 0.5); /* –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —á–µ—Ä–Ω—ã–π —Ñ–æ–Ω */
        backdrop-filter: blur(10px); /* –≠—Ñ—Ñ–µ–∫—Ç —Ä–∞–∑–º—ã—Ç–∏—è (–≥–ª–∞—Å—Å–º–æ—Ä—Ñ–æ–∑–º) */
        border: 1px solid transparent; /* –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è —Ä–∞–º–∫–∞ */
        border-image: linear-gradient(45deg, var(--gh-gold), rgba(var(--gh-gold-rgb), 0.3)) 1; /* –ó–æ–ª–æ—Ç–æ–π –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π –∫–æ–Ω—Ç—É—Ä */
        border-radius: 0.75rem; /* –°–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ —É–≥–ª—ã */
        margin-bottom: 1rem; /* –û—Ç—Å—Ç—É–ø –º–µ–∂–¥—É —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ */
        overflow: hidden; /* –í–∞–∂–Ω–æ –¥–ª—è border-image –∏ —Å–∫—Ä—É–≥–ª–µ–Ω–∏—è */
        transition: all 0.3s ease-in-out; /* –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ */
    }

    .accordion-item:hover {
        border-image: linear-gradient(45deg, var(--gh-gold), rgba(var(--gh-gold-rgb), 0.7)) 1; /* –ë–æ–ª–µ–µ —è—Ä–∫–∏–π –≥—Ä–∞–¥–∏–µ–Ω—Ç –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4); /* –õ–µ–≥–∫–∞—è —Ç–µ–Ω—å */
        transform: translateY(-2px); /* –ù–µ–±–æ–ª—å—à–æ–π –ø–æ–¥—ä–µ–º */
    }

    /* –°—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞ (–∑–∞–≥–æ–ª–æ–≤–æ–∫) */
    .accordion-button {
        background-color: rgba(0, 0, 0, 0.4); /* –ß—É—Ç—å –±–æ–ª–µ–µ —Ç–µ–º–Ω—ã–π –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω */
        color: var(--bs-body-color); /* –¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ –∏–∑ —Ç–µ–º—ã (–¥–ª—è —Å–≤–µ—Ç–ª–æ–π/—Ç–µ–º–Ω–æ–π) */
        font-weight: 500;
        padding: 1rem 1.25rem; /* –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
        border-bottom: 1px solid rgba(var(--bs-body-color-rgb), 0.1); /* –¢–æ–Ω–∫–∞—è —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω–∞—è –ª–∏–Ω–∏—è */
        transition: all 0.3s ease-in-out;
    }

    .accordion-button:not(.collapsed) {
        background-color: rgba(var(--gh-gold-rgb), 0.15); /* –ó–æ–ª–æ—Ç–æ–π —Ñ–æ–Ω –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ */
        color: var(--gh-gold); /* –ó–æ–ª–æ—Ç–æ–π —Ç–µ–∫—Å—Ç –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ */
        box-shadow: none; /* –£–±–∏—Ä–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é —Ç–µ–Ω—å */
        border-bottom-color: rgba(var(--gh-gold-rgb), 0.4); /* –ó–æ–ª–æ—Ç–∞—è —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω–∞—è –ª–∏–Ω–∏—è */
    }

    .accordion-button::after {
        filter: invert(var(--bs-accordion-btn-icon-invert)); /* –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º —Ü–≤–µ—Ç –∏–∫–æ–Ω–∫–∏ –ø–æ–¥ —Ç–µ–º—É */
        color: var(--bs-body-color); /* –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –∏–∫–æ–Ω–∫–∞ –≤–∏–¥–Ω–∞ */
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–µ–ª–∞ –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞ */
    .accordion-body {
        background-color: rgba(0, 0, 0, 0.3); /* –ù–µ–º–Ω–æ–≥–æ —Å–≤–µ—Ç–ª–µ–µ, —á–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ */
        color: var(--bs-body-color);
        padding: 1rem 1.25rem;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü –≤–Ω—É—Ç—Ä–∏ –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞ */
    .accordion-body table {
        --bs-table-bg: transparent; /* –ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω —Ç–∞–±–ª–∏—Ü—ã */
        --bs-table-color: var(--bs-body-color);
        --bs-table-border-color: rgba(var(--bs-body-color-rgb), 0.1); /* –¢–æ–Ω–∫–∏–µ —Ä–∞–º–∫–∏ */
    }
    .accordion-body .table-light thead {
        background-color: rgba(var(--gh-gold-rgb), 0.1); /* –õ–µ–≥–∫–∏–π –∑–æ–ª–æ—Ç–æ–π —Ñ–æ–Ω –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Ç–∞–±–ª–∏—Ü—ã */
        color: var(--gh-gold);
    }
</style>

{% if structured_discounts %}
    <div class="accordion" id="discountsAccordion">
        {% for complex_name, data in structured_discounts.items() %}
            {% if data.summary.sum_100_payment > 0 or data.summary.sum_mortgage > 0 %}
            <div class="accordion-item mb-2"
                 data-complex-name="{{ complex_name|lower }}"
                 data-cadastre-date-exists="{{ 'true' if data.summary.months_to_cadastre is not none else 'false' }}">
                <h2 class="accordion-header" id="heading-{{ loop.index }}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ loop.index }}" aria-expanded="false" aria-controls="collapse-{{ loop.index }}">
                        <div class="w-100">
                            <div class="row align-items-center">
                                <div class="col-lg-4">
                                    <strong class="fs-5">{{ complex_name }}</strong>
                                </div>
                                <div class="col-lg-8">
                                    <div class="row align-items-center text-center">
                                        <div class="col-4">
                                            {% if current_user.role.name in ['ADMIN', 'MANAGER'] %}
                                                {% if data.summary.avg_remainder_price_sqm > 0 %}
                                                    <div class="fw-bold fs-5" style="color: var(--gh-gold);">${{ "{:,.0f}".format(data.summary.avg_remainder_price_sqm) }}</div>
                                                    <small class="text-muted" style="font-size: 0.7rem;">—Å—Ä. —Ü–µ–Ω–∞ –¥–Ω–∞ –∑–∞ –º¬≤</small>
                                                {% else %}
                                                    <div class="fw-bold fs-6 text-warning" style="height: 35px; display: flex; align-items-center; justify-content: center;">–ö–≤–∞—Ä—Ç–∏—Ä—ã<br>—Ä–∞—Å–ø—Ä–æ–¥–∞–Ω—ã</div>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                        <div class="col-3">
                                        {% if data.summary.months_to_cadastre is not none %}
                                            <div class="fw-bold fs-5" style="color: var(--gh-gold);">{{ data.summary.months_to_cadastre }}</div>
                                            <small class="text-muted" style="font-size: 0.7rem;">–º–µ—Å. –¥–æ –∫–∞–¥–∞—Å—Ç—Ä–∞</small>
                                        {% endif %}
                                        </div>
                                        <div class="col-5">
                                             <small class="text-muted" style="font-size: 0.8rem;">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å–∫–∏–¥–∫–∏</small>
                                            <div class="d-flex justify-content-center mt-1">
                                                <div class="px-2">
                                                    <div class="fw-bold fs-5" style="color: var(--gh-gold);">{{ "%.1f"|format(data.summary.sum_100_payment * 100) }}%</div>
                                                    <small class="text-muted" style="font-size: 0.7rem;">100% –û–ø–ª–∞—Ç–∞</small>
                                                </div>
                                                <div class="px-2">
                                                    <div class="fw-bold fs-5" style="color: var(--gh-gold);">{{ "%.1f"|format(data.summary.sum_mortgage * 100) }}%</div>
                                                    <small class="text-muted" style="font-size: 0.7rem;">–ò–ø–æ—Ç–µ–∫–∞</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-2 border-top pt-2">
                                {# –°–Ω–∞—á–∞–ª–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤—Å–µ —Ç–µ–≥–∏ #}
                                {% if data.summary.max_action_discount > 0 %}
                                    <span class="badge rounded-pill bg-danger-subtle border border-danger-subtle text-danger-emphasis fs-6 me-1">
                                        <i class="bi bi-star-fill"></i>
                                        –ê–∫—Ü–∏—è: {{ "%.1f"|format(data.summary.max_action_discount * 100) }}%
                                    </span>
                                {% endif %}
                                {% for tag in data.summary.available_tags|sort %}
                                    {% set tag_class = 'secondary' %}
                                    {% if tag == '–ö–î' %}{% set tag_class = 'success' %}{% endif %}
                                    {% if tag == '–û–ü–¢' %}{% set tag_class = 'info' %}{% endif %}
                                    {% if tag == '–•–æ–ª–¥–∏–Ω–≥' %}{% set tag_class = 'primary' %}{% endif %}
                                    <span class="badge rounded-pill bg-{{tag_class}}-subtle border border-{{tag_class}}-subtle text-{{tag_class}}-emphasis me-1">{{ tag }}</span>
                                {% endfor %}

                                {# –í –∫–æ–Ω—Ü–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å #}
                                {% if data.summary.complex_comment %}
                                <span class="ms-3 fst-italic text-muted" style="font-size: 0.85rem;">
                                    <i class="bi bi-chat-left-text"></i> {{ data.summary.complex_comment }}
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </button>
                </h2>
                <div id="collapse-{{ loop.index }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ loop.index }}">
                    <div class="accordion-body">
                        {% for prop_type, discounts in data.details.items() if discounts %}
                            <h5 class="mt-3">–¢–∏–ø –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏: <span class="badge bg-info-subtle border border-info-subtle text-info-emphasis rounded-pill">{{ prop_type }}</span></h5>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered mt-2">
                                    <thead class="table-light">
                                        <tr>
                                            <th>–¢–∏–ø –æ–ø–ª–∞—Ç—ã</th>
                                            <th>–î–∞—Ç–∞ –∫–∞–¥–∞—Å—Ç—Ä–∞</th>
                                            <th>–ú–ü–ü</th>
                                            <th>–†–û–ü</th>
                                            <th>–ö–î</th>
                                            <th>–û–ü–¢</th>
                                            <th>–ì–î</th>
                                            <th>–•–æ–ª–¥–∏–Ω–≥</th>
                                            <th>–ê–∫—Ü–∏—è</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for discount in discounts|sort(attribute='payment_method.value') %}
                                            {% set payment_method_value = discount.payment_method.value %}
                                            {% set show_row = false %}
                                            {% if prop_type == '–ö–≤–∞—Ä—Ç–∏—Ä–∞' %}{% set show_row = true %}{% endif %}
                                            {% if prop_type in ['–ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø–æ–º–µ—â–µ–Ω–∏–µ', '–ö–ª–∞–¥–æ–≤–æ–µ –ø–æ–º–µ—â–µ–Ω–∏–µ'] and payment_method_value == '100% –æ–ø–ª–∞—Ç–∞' %}{% set show_row = true %}{% endif %}
                                            {% if prop_type == '–ü–∞—Ä–∫–æ–≤–∫–∞' and payment_method_value in ['100% –æ–ø–ª–∞—Ç–∞', '–ò–ø–æ—Ç–µ–∫–∞'] %}{% set show_row = true %}{% endif %}

                                            {% if show_row %}
                                            <tr>
                                                <td><strong>{{ payment_method_value }}</strong></td>
                                                <td>{{ discount.cadastre_date.strftime('%d.%m.%Y') if discount.cadastre_date else '‚Äî' }}</td>
                                                <td>{% if discount.mpp > 0 %}{{ "%.1f"|format(discount.mpp * 100) }}%{% else %}‚Äî{% endif %}</td>
                                                <td>{% if discount.rop > 0 %}{{ "%.1f"|format(discount.rop * 100) }}%{% else %}‚Äî{% endif %}</td>
                                                <td>{% if discount.kd > 0 %}{{ "%.1f"|format(discount.kd * 100) }}%{% else %}‚Äî{% endif %}</td>
                                                <td>{% if discount.opt > 0 %}{{ "%.1f"|format(discount.opt * 100) }}%{% else %}‚Äî{% endif %}</td>
                                                <td>{% if discount.gd is not none and discount.gd > 0 %}{{ "%.1f"|format(discount.gd * 100) }}%{% else %}‚Äî{% endif %}</td>
                                                <td>{% if discount.holding > 0 %}{{ "%.1f"|format(discount.holding * 100) }}%{% else %}‚Äî{% endif %}</td>
                                                <td>{% if discount.action > 0 %}{{ "%.1f"|format(discount.action * 100) }}%{% else %}‚Äî{% endif %}</td>
                                            </tr>
                                            {% endif %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        {% endfor %}
    </div>
{% else %}
    <div class="alert alert-warning">–í —Å–∏—Å—Ç–µ–º–µ –ø–æ–∫–∞ –Ω–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö —Å–∫–∏–¥–æ–∫.</div>
{% endif %}
{% endblock %}


{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.getElementById('searchInput');
    const showOnlyCadastreSwitch = document.getElementById('showOnlyCadastreSwitch');
    const accordionItems = document.querySelectorAll('.accordion-item');

    function applyFilters() {
        const searchTerm = searchInput.value.toLowerCase();
        const showCadastreOnly = showOnlyCadastreSwitch.checked;

        accordionItems.forEach(function (item) {
            const complexName = item.dataset.complexName;
            const hasCadastreDate = item.dataset.cadastreDateExists === 'true';

            const searchMatch = complexName.includes(searchTerm);
            const cadastreMatch = !showCadastreOnly || hasCadastreDate;

            if (searchMatch && cadastreMatch) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }

    if (searchInput) {
        searchInput.addEventListener('input', applyFilters);
    }
    if (showOnlyCadastreSwitch) {
        showOnlyCadastreSwitch.addEventListener('change', applyFilters);
    }

    applyFilters();
});
</script>
{% endblock %}