{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Управление скидками</h1>
    <div>
        <form action="{{ url_for('web.new_discount_version') }}" method="POST" style="display: inline;">
            <button type="submit" class="btn btn-success">
                <i class="bi bi-plus-circle"></i> Создать новую версию
            </button>
        </form>
    </div>
</div>

<div class="card mb-4">
    <div class="card-body d-flex justify-content-between align-items-center">
        <div>
            <label for="versionSelector" class="form-label">Просмотр и редактирование версии:</label>
            <select id="versionSelector" class="form-select w-auto d-inline-block">
                {% for v in versions %}
                    <option value="{{ v.version }}" {% if v.version == current_version %}selected{% endif %}>
                        Версия {{ v.version }} (от {{ v.created_at.strftime('%Y-%m-%d %H:%M') }})
                        {% if v.version == active_version %} (АКТИВНАЯ){% endif %}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div>
            {% if current_version != active_version %}
            <form action="{{ url_for('web.activate_version', version_id=current_version) }}" method="POST" class="d-inline">
                <button type="submit" class="btn btn-primary">Активировать эту версию</button>
            </form>
            {% else %}
            <span class="badge bg-success fs-6">Эта версия активна</span>
            {% endif %}
        </div>
    </div>
</div>


<div class="row mb-3">
    <div class="col-md-6">
        <input type="text" id="searchComplex" class="form-control" placeholder="Поиск по названию ЖК...">
    </div>
    <div class="col-md-6">
        <select id="filterPropType" class="form-select">
            <option value="">Все типы недвижимости</option>
            {% for type in ['flat', 'comm', 'garage', 'storageroom'] %}
            <option value="{{ type }}">{{ type }}</option>
            {% endfor %}
        </select>
    </div>
</div>

<form method="POST" action="{{ url_for('web.manage_discounts', version_id=current_version) }}">
    <div class="table-responsive">
        <table class="table table-bordered table-hover">
            <thead>
                <tr>
                    <th>ЖК</th>
                    <th>Тип недв.</th>
                    <th>Тип оплаты</th>
                    <th>МПП (%)</th>
                    <th>РОП (%)</th>
                    <th>КД (%)</th>
                    <th>Акция (%)</th>
                </tr>
            </thead>
            <tbody id="discountsTableBody">
                {% for discount in discounts %}
                <tr data-complex="{{ discount.complex_name|lower }}" data-prop-type="{{ discount.property_type.value|lower }}">
                    <td>{{ discount.complex_name }}</td>
                    <td>{{ discount.property_type.value }}</td>
                    <td>{{ discount.payment_method.value }}</td>
                    <td><input type="number" step="0.1" class="form-control editable" name="discount-{{ discount.id }}-mpp" value="{{ discount.mpp * 100 }}"></td>
                    <td><input type="number" step="0.1" class="form-control editable" name="discount-{{ discount.id }}-rop" value="{{ discount.rop * 100 }}"></td>
                    <td><input type="number" step="0.1" class="form-control editable" name="discount-{{ discount.id }}-kd" value="{{ discount.kd * 100 }}"></td>
                    <td><input type="number" step="0.1" class="form-control editable" name="discount-{{ discount.id }}-action" value="{{ discount.action * 100 }}"></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <button type="submit" class="btn btn-warning mt-3">
        <i class="bi bi-save"></i> Сохранить все изменения
    </button>
</form>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 1. Переключение версий
    const versionSelector = document.getElementById('versionSelector');
    versionSelector.addEventListener('change', function() {
        const selectedVersion = this.value;
        window.location.href = `{{ url_for('web.manage_discounts') }}?version_id=${selectedVersion}`;
    });

    // 2. Подсветка редактируемых ячеек
    const editableInputs = document.querySelectorAll('.editable');
    editableInputs.forEach(input => {
        const originalValue = input.value;
        input.addEventListener('input', function() {
            if (input.value !== originalValue) {
                // Подсвечиваем ячейку, если значение изменилось
                input.parentElement.style.backgroundColor = 'rgba(255, 193, 7, 0.3)';
            } else {
                input.parentElement.style.backgroundColor = '';
            }
        });
    });

    // 3. Фильтрация и поиск
    const searchInput = document.getElementById('searchComplex');
    const propTypeFilter = document.getElementById('filterPropType');
    const tableRows = document.querySelectorAll('#discountsTableBody tr');

    function applyFilters() {
        const searchTerm = searchInput.value.toLowerCase();
        const propType = propTypeFilter.value.toLowerCase();

        tableRows.forEach(row => {
            const complexMatch = row.dataset.complex.includes(searchTerm);
            const propTypeMatch = propType === '' || row.dataset.propType === propType;

            if (complexMatch && propTypeMatch) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    searchInput.addEventListener('input', applyFilters);
    propTypeFilter.addEventListener('change', applyFilters);
});
</script>
{% endblock %}