<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>{{ title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/commercial_offer_style.css') }}">
</head>

<body class="theme-jeweler" data-usd-rate="{{ usd_to_uzs_rate }}">
    <div class="page-container">

        <div class="no-print d-flex justify-content-end align-items-center mb-3 gap-3">
             <div class="me-auto">
                 <small class="text-muted">{{ _('Тема:') }}</small>
                 <strong id="current-theme-display"></strong>
             </div>

             <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="currency-switcher">
                <label class="form-check-label" for="currency-switcher">USD</label>
             </div>
             <button id="theme-switcher" class="btn btn-outline-secondary btn-sm">{{ _('Сменить тему') }}</button>
             <button class="btn btn-primary btn-sm" onclick="window.print()">{{ _('Печать') }}</button>
        </div>

        <div class="header">
            <div class="header-logo">
                </div>
            <h1>{{ _('Коммерческое предложение') }}</h1>
            <p><strong>Golden House | {{ _('Жилая недвижимость') }}. {{ _('Дата') }}: {{ current_date }}</strong></p>
        </div>

        <div class="layout-wrapper">
            <div class="layout-main">
                <div class="section-title">1. {{ _('Информация об объекте') }}</div>
                <div class="info-block">
                    <div class="info-item">
                        <span class="info-label">{{ _('ЖК:') }}</span>
                        <span class="info-value">{{ data.apartment.house.complex_name }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">{{ _('Тип/Комнат:') }}</span>
                        <span class="info-value">{{ _(data.apartment.estate_sell_category) }} / {{ data.apartment.estate_rooms }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">{{ _('Этаж:') }}</span>
                        <span class="info-value">{{ data.apartment.estate_floor }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">{{ _('Площадь:') }}</span>
                        <span class="info-value">{{ data.apartment.estate_area }} м²</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">{{ _('Стоимость по прайсу:') }}</span>
                        <span class="info-value price-value" data-uzs-value="{{ data.apartment.estate_price }}">{{ "{:,.0f}".format(data.apartment.estate_price)|replace(',', '.') }} UZS</span>
                    </div>
                    </div>

                <div class="section-title">2. {{ _('Детализация расчета') }}</div>
                <div class="calc-details-card">
                    <div class="card-body">
                        {% if calc_type == 'standard_installment' %}
                            <h5 class="card-title text-primary">{{ _('Расчет по стандартной рассрочке') }}</h5>
                            <p class="card-text">
                                {% trans term=details.term_months %}
                                Расчет произведен на срок <strong>{{ term }} мес.</strong>
                                {% endtrans %}
                            </p>
                            <hr>
                            <dl>
                                <dt>{{ _('Стоимость по прайсу:') }}</dt>
                                <dd><span class="price-value" data-uzs-value="{{ details.price_list }}">{{ "{:,.0f}".format(details.price_list)|replace(',', '.') }} UZS</span></dd>
                                <dt>{{ _('Расчетная скидка:') }}</dt>
                                <dd class="text-danger">{{ "%.2f"|format(details.calculated_discount) }}%</dd>
                                <dt class="result-row">{{ _('Итоговая стоимость договора:') }}</dt>
                                <dd class="result-row price-final"><span class="price-value" data-uzs-value="{{ details.calculated_contract_value }}">{{ "{:,.0f}".format(details.calculated_contract_value)|replace(',', '.') }} UZS</span></dd>
                                <dt class="border-top pt-2 mt-2">{{ _('Первоначальный взнос:') }}</dt>
                                <dd class="border-top pt-2 mt-2 fw-bold"><span class="price-value" data-uzs-value="{{ details.initial_payment_uzs }}">{{ "{:,.0f}".format(details.initial_payment_uzs)|replace(',', '.') }} UZS</span></dd>
                                <dt>{{ _('Ежемесячный платеж:') }}</dt>
                                <dd class="fw-bold"><span class="price-value" data-uzs-value="{{ details.monthly_payment }}">{{ "{:,.0f}".format(details.monthly_payment)|replace(',', '.') }} UZS</span></dd>
                            </dl>
                            {% elif calc_type == 'dp_installment' %}
                             <h5 class="card-title text-primary">{{ _('Расчет по рассрочке на Первоначальный Взнос') }}</h5>
                             <p class="card-text">
                                {% trans term=details.term_months %}
                                Рассрочка на ПВ на срок <strong>{{ term }} мес.</strong>
                                {% endtrans %}
                            </p>
                            <hr>
                            <dl>
                                <dt class="result-row">{{ _('Итоговая стоимость договора:') }}</dt>
                                <dd class="result-row price-final"><span class="price-value" data-uzs-value="{{ details.calculated_contract_value }}">{{ "{:,.0f}".format(details.calculated_contract_value)|replace(',', '.') }} UZS</span></dd>

                                <dt class="border-top pt-2 mt-2">{{ _('Ежемесячный платеж по ПВ:') }}</dt>
                                <dd class="border-top pt-2 mt-2 fw-bold"><span class="price-value" data-uzs-value="{{ details.monthly_payment_for_dp }}">{{ "{:,.0f}".format(details.monthly_payment_for_dp)|replace(',', '.') }} UZS</span></dd>

                                <dt>{{ _('Тело ипотеки (в банк):') }}</dt>
                                <dd class="fw-bold"><span class="price-value" data-uzs-value="{{ details.mortgage_body }}">{{ "{:,.0f}".format(details.mortgage_body)|replace(',', '.') }} UZS</span></dd>
                            </dl>
                             {% elif calc_type == 'zero_mortgage' %}
                            <h5 class="card-title text-primary">{{ _('Расчет по "Ипотеке под 0%%"') }}</h5>
                            <p class="card-text">
                                {% trans term=details.term_months, dp=details.dp_percent %}
                                Расчет произведен на срок <strong>{{ term }} мес.</strong> с первоначальным взносом <strong>{{ dp }}%</strong>.
                                {% endtrans %}
                            </p>
                            <hr>
                            <dl>
                                <dt class="result-row">{{ _('Итоговая стоимость договора:') }}</dt>
                                <dd class="result-row price-final"><span class="price-value" data-uzs-value="{{ details.contract_value }}">{{ "{:,.0f}".format(details.contract_value)|replace(',', '.') }} UZS</span></dd>

                                <dt class="border-top pt-2 mt-2">{{ _('Первоначальный взнос:') }}</dt>
                                <dd class="border-top pt-2 mt-2 fw-bold"><span class="price-value" data-uzs-value="{{ details.initial_payment }}">{{ "{:,.0f}".format(details.initial_payment)|replace(',', '.') }} UZS</span></dd>

                                <dt>{{ _('Ежемесячный платеж:') }}</dt>
                                <dd class="fw-bold"><span class="price-value" data-uzs-value="{{ details.monthly_payment }}">{{ "{:,.0f}".format(details.monthly_payment)|replace(',', '.') }} UZS</span></dd>
                            </dl>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="layout-sidebar">
                {% if details.payment_schedule %}
                <div class="section-title">3. {{ _('График платежей') }}</div>
                <table class="table table-sm payment-schedule-table">
                    <thead><tr><th scope="col">№</th><th scope="col">{{ _('Дата платежа') }}</th><th scope="col">{{ _('Описание') }}</th><th scope="col" class="text-end">{{ _('Сумма') }}</th></tr></thead>
                    <tbody>
                        {% for payment in details.payment_schedule %}
                        <tr>
                            <td>{{ payment.month_number }}</td>
                            <td>{{ payment.payment_date.strftime('%d.%m.%Y') }}</td>
                            <td>
                                {% if payment.type == 'monthly_payment' %} {{ _('Ежемесячный платеж') }}
                                {% elif payment.type == 'dp_payment' %} {{ _('Платеж по рассрочке на ПВ') }}
                                {% elif payment.type == 'mortgage_body' %} <strong class="text-primary">{{ _('Ипотечный кредит (в банке)') }}</strong>
                                {% elif payment.type == 'initial_payment' %} <strong class="text-success">{{ _('Первоначальный взнос') }}</strong>
                                {% endif %}
                            </td>
                            <td class="text-end fw-bold"><span class="price-value" data-uzs-value="{{ payment.amount }}">{{ "{:,.0f}".format(payment.amount)|replace(',', '.') }}</span> <span class="currency-symbol">UZS</span></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% endif %}
            </div>
        </div>

        <div class="footer">
            <p>{% trans %}Это коммерческое предложение не является публичной офертой. Актуальность цен и условий уточняйте у менеджеров Golden House.{% endtrans %}</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- ЛОГИКА ПЕРЕКЛЮЧАТЕЛЯ ТЕМ ---
            const themeSwitcher = document.getElementById('theme-switcher');
            const themeDisplay = document.getElementById('current-theme-display');
            const body = document.body;
            const themes = [ { class: 'theme-jeweler', name: '{{ _("Ювелир") }}' }, { class: 'theme-architect', name: '{{ _("Архитектор") }}' }, { class: 'theme-parchment', name: '{{ _("Парчмент") }}' }, { class: 'theme-gallery', name: '{{ _("Галерея") }}' }, { class: 'theme-infographic', name: '{{ _("Инфографика") }}' } ];
            let currentThemeIndex = themes.findIndex(theme => body.classList.contains(theme.class));
            if (currentThemeIndex === -1) { currentThemeIndex = 0; body.classList.add(themes[0].class); }
            function updateThemeDisplay() { if(themeDisplay) { themeDisplay.textContent = themes[currentThemeIndex].name; } }
            if(themeSwitcher) {
                themeSwitcher.addEventListener('click', function() {
                    currentThemeIndex = (currentThemeIndex + 1) % themes.length;
                    body.className = '';
                    body.classList.add(themes[currentThemeIndex].class);
                    updateThemeDisplay();
                });
            }
            updateThemeDisplay();

            // --- НАЧАЛО: НОВАЯ ЛОГИКА ПЕРЕКЛЮЧАТЕЛЯ ВАЛЮТ ---
            const currencySwitcher = document.getElementById('currency-switcher');
            const usdRate = parseFloat(document.body.dataset.usdRate);

            function formatNumberWithDots(num) {
                return Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            }

            function updatePrices() {
                const isUsd = currencySwitcher.checked;
                document.querySelectorAll('.price-value').forEach(el => {
                    const uzsValue = parseFloat(el.dataset.uzsValue);
                    if (isNaN(uzsValue)) return;

                    let displayValue;
                    let symbol = isUsd ? '$' : 'UZS';

                    if (isUsd) {
                        displayValue = formatNumberWithDots(uzsValue / usdRate);
                        // Для элементов с символом валюты снаружи
                        if (el.nextElementSibling && el.nextElementSibling.classList.contains('currency-symbol')) {
                           el.nextElementSibling.textContent = ''; // Убираем UZS
                           el.textContent = '$' + displayValue;
                        } else {
                           el.textContent = '$' + displayValue;
                        }
                    } else {
                        displayValue = formatNumberWithDots(uzsValue);
                         if (el.nextElementSibling && el.nextElementSibling.classList.contains('currency-symbol')) {
                           el.nextElementSibling.textContent = 'UZS';
                           el.textContent = displayValue;
                        } else {
                           el.textContent = displayValue + ' UZS';
                        }
                    }
                });
                // Обновляем заголовок в таблице
                const tableHeader = document.querySelector('.payment-schedule-table th:last-child');
                if (tableHeader) {
                    tableHeader.textContent = isUsd ? '{{ _("Сумма ($)") }}' : '{{ _("Сумма (UZS)") }}';
                }
            }

            if (currencySwitcher && !isNaN(usdRate)) {
                currencySwitcher.addEventListener('change', updatePrices);
                // Инициализируем при загрузке
                updatePrices();
            }
        });
    </script>
</body>
</html>