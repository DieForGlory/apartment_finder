{% extends "base.html" %}

{% macro render_metric(value, base, name) %}
    <li class="list-group-item d-flex justify-content-between align-items-center">
        <span>{{ name }}</span>
        <span class="fw-bold">
            {{ value }}
            {% if base > 0 %}
                <span class="ms-2 badge rounded-pill bg-secondary fw-normal">{{ "%.1f"|format(value * 100 / base) }}%</span>
            {% endif %}
        </span>
    </li>
{% endmacro %}


{% block content %}
<h1 class="mb-4">Ключевые метрики воронки</h1>

<div class="card card-glass mb-4">
    <div class="card-body">
        <h5 class="card-title">Фильтр по дате создания заявки</h5>
        <form method="GET">
            <div class="row g-2 align-items-end">
                <div class="col-md-5"><label for="start_date" class="form-label">От</label><input type="date" name="start_date" id="start_date" class="form-control" value="{{ filters.start_date }}"></div>
                <div class="col-md-5"><label for="end_date" class="form-label">До</label><input type="date" name="end_date" id="end_date" class="form-control" value="{{ filters.end_date }}"></div>
                <div class="col-md-2"><button type="submit" class="btn btn-primary w-100">Применить</button></div>
            </div>
        </form>
    </div>
</div>

{% if data and data.total_leads > 0 %}
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card card-glass text-center h-100">
                <div class="card-body">
                    <h6 class="text-muted">Всего заявок</h6>
                    <h2 class="display-5 fw-bold">{{ data.total_leads }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card card-glass text-center h-100">
                <div class="card-body">
                    <h6 class="text-muted">Целевые</h6>
                    <h2 class="display-5 fw-bold text-success">{{ data.target_leads.count }}</h2>
                    <div class="fs-5 text-success">{{ "%.1f"|format(data.target_leads.count * 100 / data.total_leads) }}%</div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card card-glass text-center h-100">
                <div class="card-body">
                    <h6 class="text-muted">Нецелевые</h6>
                    <h2 class="display-5 fw-bold text-danger">{{ data.nontarget_leads.count }}</h2>
                    <div class="fs-5 text-danger">{{ "%.1f"|format(data.nontarget_leads.count * 100 / data.total_leads) }}%</div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-4">
            <div class="card card-glass h-100">
                <div class="card-header">Конверсии из "Подбора" ({{ data.metrics.from_podbor.base_count }} заявок)</div>
                <ul class="list-group list-group-flush">
                    {{ render_metric(data.metrics.from_podbor.to_vstrecha, data.metrics.from_podbor.base_count, 'в Назначенную встречу') }}
                    {{ render_metric(data.metrics.from_podbor.to_bron, data.metrics.from_podbor.base_count, 'в Бронь') }}
                    {{ render_metric(data.metrics.from_podbor.to_otkaz, data.metrics.from_podbor.base_count, 'в Отказ') }}
                </ul>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card card-glass h-100">
                <div class="card-header">Конверсии из "Назначенной встречи" ({{ data.metrics.from_vstrecha.base_count }} заявок)</div>
                 <ul class="list-group list-group-flush">
                    {{ render_metric(data.metrics.from_vstrecha.to_sostoyalas, data.metrics.from_vstrecha.base_count, 'в Визит состоялся') }}
                    {{ render_metric(data.metrics.from_vstrecha.to_nesostoyalas, data.metrics.from_vstrecha.base_count, 'в Визит не состоялся') }}
                    {{ render_metric(data.metrics.from_vstrecha.to_bron, data.metrics.from_vstrecha.base_count, 'в Бронь') }}
                </ul>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card card-glass h-100">
                <div class="card-header">Конверсии из "Визит состоялся" ({{ data.metrics.from_vizit.base_count }} заявок)</div>
                 <ul class="list-group list-group-flush">
                    {{ render_metric(data.metrics.from_vizit.to_bron, data.metrics.from_vizit.base_count, 'в Бронь') }}
                </ul>
            </div>
        </div>
    </div>

{% else %}
    <div class="card card-glass text-center p-5">
        <p class="lead text-muted">Нет данных за выбранный период.</p>
    </div>
{% endif %}

{% endblock %}